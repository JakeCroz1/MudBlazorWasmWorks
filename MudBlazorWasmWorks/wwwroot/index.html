<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MudBlazorWasmWorks</title>
    <base href="/" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />
    <link href="MudBlazorWasmWorks.styles.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
    <script src="/scripts/p5sound.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>-->
</head>

<body>
    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <button onclick="startMic()" style="background-color:aqua; width:100%; height: 50px; ">click</button>
    <script>
        let inputz;
        let analyzer;

        function setup() {
            createCanvas(710, 200);
            background(255);

            // Create an Audio input
            inputz = new p5.AudioIn();
            
            //inputz.start();
        }

        function startMic() {
            getAudioContext().resume();

            inputz.start();
        }

        function draw() {
            // Get the overall volume (between 0 and 1.0)
            let volumez = inputz.getLevel();

            // If the volume > 0.1,  a rect is drawn at a random location.
            // The louder the volume, the larger the rectangle.
            let thresholdz = 0.1;
            if (volumez > thresholdz) {
                stroke(0);
                fill(0, 100);
                rect(random(40, width), random(height), volumez * 50, volumez * 50);
            }

            // Graph the overall potential volume, w/ a line at the threshold
            let y = map(volumez, 0, 1, height, 0);
            let ythreshold = map(thresholdz, 0, 1, height, 0);

            noStroke();
            fill(175);
            rect(0, 0, 20, height);
            // Then draw a rectangle on the graph, sized according to volume
            fill(0);
            rect(0, y, 20, y);
            stroke(0);
            line(0, ythreshold, 19, ythreshold);
        }
        /*
        const avgWindow = 20;
        const threshold = 0.12;

        let song;
        let fft;
        let beat;
        let lastPeak;

        function preload() {
            song = loadSound('https://beststorageever2020.blob.core.windows.net/video4/TapTest.mp3');
        }

        function setup() {
            let cnv = createCanvas(400, 400);
            cnv.mouseClicked(togglePlay);
            fft = new p5.FFT();

            beat = millis();
            //song.loop();
        }

        function draw() {
            // Pulse white on the beat, then fade out with an inverse cube curve
            background(map(1 / pow((millis() - beat) / 1000 + 1, 3), 1, 0, 255, 100));
            drawSpectrumGraph(0, 0, width, height);
        }

        let i = 0;
        // Graphing code adapted from https://jankozeluh.g6.cz/index.html by Jan KoÅ¾eluh
        function drawSpectrumGraph(left, top, w, h) {
            let spectrum = fft.analyze();

            stroke('limegreen');
            fill('darkgreen');
            strokeWeight(1);

            beginShape();
            vertex(left, top + h);

            let peak = 0;
            // compute a running average of values to avoid very
            // localized energy from triggering a beat.
            let runningAvg = 0;
            for (let i = 0; i < spectrum.length; i++) {
                vertex(
                    //left + map(i, 0, spectrum.length, 0, w),
                    // Distribute the spectrum values on a logarithmic scale
                    // We do this because as you go higher in the spectrum
                    // the same perceptible difference in tone requires a
                    // much larger chang in frequency.
                    left + map(log(i), 0, log(spectrum.length), 0, w),
                    // Spectrum values range from 0 to 255
                    top + map(spectrum[i], 0, 255, h, 0)
                );

                runningAvg += spectrum[i] / avgWindow;
                if (i >= avgWindow) {
                    runningAvg -= spectrum[i] / avgWindow;
                }
                if (runningAvg > peak) {
                    peak = runningAvg;
                }
            }

            // any time there is a sudden increase in peak energy, call that a beat
            if (peak > lastPeak * (1 + threshold)) {
                window.ReactNativeWebView.postMessage('callReactNativeFunction');

                console.log("beat");
                beat = millis();
            }
            lastPeak = peak;

            vertex(left + w, top + h);
            endShape(CLOSE);
            // this is the range of frequencies covered by the FFT
            let nyquist = 22050;

            // get the centroid (value in hz)
            let centroid = fft.getCentroid();

            // the mean_freq_index calculation is for the display.
            // centroid frequency / hz per bucket
            let mean_freq_index = centroid / (nyquist / spectrum.length);
            stroke('red');
            // convert index to x value using a logarithmic x axis
            let cx = map(log(mean_freq_index), 0, log(spectrum.length), 0, width);
            line(cx, 0, cx, h);
        }
        function togglePlay() {
            if (song.isPlaying()) {
                song.pause();
            } else {
                song.loop();
                //amplitude = new p5.Amplitude();
                //amplitude.setInput(sound);
            }
        }
        */
    </script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
</body>

</html>